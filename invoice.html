<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Invoice Generator — Trade Nest</title>
<style>
  :root{--bg:#fbfbfd;--panel:#fff;--primary:#6c4ed2;--primary-dark:#563ab8;--muted:#6b6b6b;--border:#e6e0ef;--radius:14px;--shadow:0 10px 30px rgba(28,18,54,.08)}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,"Segoe UI",system-ui,Arial;background:var(--bg);color:#222}
  .wrap{max-width:1080px;margin:auto;padding:18px 18px 42px}
  .back{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--panel);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.04);text-decoration:none;color:#222}
  .back:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
  .title{font-size:22px;margin:16px 0 8px}
  .flex{display:flex;gap:14px;flex-wrap:wrap}
  .panel{flex:1 1 420px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  label{font-size:13px;color:var(--muted);font-weight:700;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;background:#fff;outline:none}
  textarea{min-height:92px;resize:vertical}
  .btn{background:var(--primary);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--primary-dark)}
  .chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:14px}
  tfoot td{font-weight:800}
  .right{text-align:right}
  .muted{color:var(--muted);font-size:13px}
  .invoice{background:#fff;border:1px solid var(--border);border-radius:16px;padding:18px}
  .brand{font-weight:900;font-size:18px;color:#3a2bb0}
  .spinner{width:18px;height:18px;border:3px solid #ddd;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media print{ .no-print{display:none} body{background:#fff} .invoice{border:none} }
</style>
</head>
<body>
<main class="wrap">
  <div class="no-print" style="display:flex;justify-content:space-between;align-items:center">
    <a class="back" href="growth_tool.html">← Back to Growth Tools</a>
    <button id="setKeyBtn" class="chip">Set API Key</button>
  </div>

  <h1 class="title">Invoice Generator</h1>
  <p class="muted">Fill the essentials, then let AI write polished payment terms and a client email. Print to PDF when ready.</p>

  <section class="flex">
    <!-- Form -->
    <div class="panel" aria-label="Invoice form">
      <div class="flex">
        <div style="flex:1 1 220px">
          <label>From (Business)</label>
          <input id="fromName" placeholder="Trade Nest Ltd." />
        </div>
        <div style="flex:1 1 220px">
          <label>To (Client)</label>
          <input id="toName" placeholder="Jessie Oyawiri" />
        </div>
      </div>

      <div class="flex">
        <div style="flex:1 1 220px">
          <label>Invoice #</label>
          <input id="invNo" value="INV-{{auto}}" />
        </div>
        <div style="flex:1 1 220px">
          <label>Due Date</label>
          <input id="due" type="date" />
        </div>
        <div style="flex:1 1 160px">
          <label>Currency</label>
          <select id="cur">
            <option>₦</option><option>$</option><option>€</option><option>£</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Line Items</label>
        <table id="items">
          <thead><tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Total</th><th class="no-print"></th></tr></thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="5" class="no-print"><button class="chip" id="addRow">+ Add Row</button> <button class="chip" id="aiRows">Suggest with AI</button> <span id="rowLoad" class="muted"></span></td></tr>
          </tfoot>
        </table>
      </div>

      <div class="flex" style="margin-top:10px">
        <div style="flex:1 1 200px">
          <label>Tax %</label>
          <input id="tax" type="number" step="0.01" value="0" />
        </div>
        <div style="flex:1 1 200px">
          <label>Discount %</label>
          <input id="disc" type="number" step="0.01" value="0" />
        </div>
      </div>

      <div class="flex" style="margin-top:12px;align-items:center;justify-content:space-between">
        <div>
          <button class="btn" id="build">Build Invoice</button>
          <span id="aiLoading" class="muted"></span>
        </div>
        <div>
          <button class="chip no-print" id="printBtn">Print / PDF</button>
          <button class="chip" id="copyEmail">Copy Client Email</button>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="panel" aria-label="Invoice preview">
      <div id="invoice" class="invoice">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="brand">Trade Nest</div>
          <div id="invMeta" class="muted">Invoice</div>
        </div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div class="muted">From</div>
            <div id="pFrom" style="font-weight:800">—</div>
          </div>
          <div>
            <div class="muted">Bill To</div>
            <div id="pTo" style="font-weight:800">—</div>
          </div>
        </div>

        <table style="margin-top:12px">
          <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Total</th></tr></thead>
          <tbody id="pItems"></tbody>
          <tfoot id="pTotals"></tfoot>
        </table>

        <div style="margin-top:12px">
          <div class="muted">Payment Terms</div>
          <div id="terms">—</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  // Key helpers
  function getKey(){ return localStorage.getItem('tn_ai_key') || '' }
  function setKey(k){ localStorage.setItem('tn_ai_key', k||'') }
  document.getElementById('setKeyBtn').onclick = ()=>{ const v = prompt('Paste your AI API key:', getKey()); if(v!=null){ setKey(v.trim()); alert('Saved.'); } };

  // AI helper
  async function callAI(messages, temperature=0.7){
    const key = getKey(); if(!key) throw new Error('Missing API key.');
    const res = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model:'gpt-4o-mini',temperature,messages})
    });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error?.message || 'AI error');
    return j.choices?.[0]?.message?.content || '';
  }

  // Line items table
  const tbody = document.querySelector('#items tbody');
  function addRow(desc='', qty=1, unit=0){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${desc}"/></td>
      <td class="right"><input type="number" step="1" min="0" value="${qty}" style="width:90px;text-align:right"/></td>
      <td class="right"><input type="number" step="0.01" min="0" value="${unit}" style="width:110px;text-align:right"/></td>
      <td class="right"><span class="rowTotal">0</span></td>
      <td class="no-print"><button class="chip del">✕</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector('.del')?.addEventListener('click', ()=>tr.remove());
    updateRow(tr);
    tr.querySelectorAll('input').forEach(i=> i.addEventListener('input', ()=>updateRow(tr)));
  }
  function updateRow(tr){
    const inputs = tr.querySelectorAll('input');
    const qty = parseFloat(inputs[1].value)||0;
    const unit = parseFloat(inputs[2].value)||0;
    tr.querySelector('.rowTotal').textContent = (qty*unit).toFixed(2);
  }
  document.getElementById('addRow').onclick = ()=>addRow('',1,0);
  // Seed two rows
  addRow('Product / Service', 1, 0);
  addRow('Additional item', 1, 0);

  // Suggest items with AI
  document.getElementById('aiRows').onclick = async ()=>{
    const rowLoad = document.getElementById('rowLoad');
    rowLoad.innerHTML = '<span class="spinner"></span> Asking AI…';
    try{
      const out = await callAI([
        {role:'system', content:'You suggest concise invoice line items.'},
        {role:'user', content:'Suggest up to 3 invoice line items with a short description and a suggested unit price in NGN for a small business. Return JSON array of objects with fields: description, qty, unit.'}
      ], 0.4);
      const data = JSON.parse(out);
      data.forEach(x=> addRow(x.description || '', x.qty || 1, x.unit || 0));
    }catch(e){ alert('Could not fetch AI suggestions. You can add rows manually.'); }
    rowLoad.textContent = '';
  };

  // Build invoice & ask AI for terms + email
  document.getElementById('build').onclick = async ()=>{
    const from = document.getElementById('fromName').value.trim() || '—';
    const to = document.getElementById('toName').value.trim() || '—';
    const cur = document.getElementById('cur').value;
    const invNo = (document.getElementById('invNo').value || 'INV-'+Math.floor(Math.random()*9000+1000)).replace('{{auto}}', Math.floor(Math.random()*900000));
    const due = document.getElementById('due').value || '—';
    const tax = parseFloat(document.getElementById('tax').value)||0;
    const disc = parseFloat(document.getElementById('disc').value)||0;

    const rows = [...tbody.querySelectorAll('tr')].map(tr=>{
      const [d, q, u] = tr.querySelectorAll('input');
      return {d:d.value, q:parseFloat(q.value)||0, u:parseFloat(u.value)||0, t: (parseFloat(q.value)||0)*(parseFloat(u.value)||0)};
    });

    // Preview
    document.getElementById('pFrom').textContent = from;
    document.getElementById('pTo').textContent = to;
    document.getElementById('invMeta').textContent = `Invoice • ${invNo} • Due ${due}`;

    const pItems = document.getElementById('pItems'); pItems.innerHTML='';
    let sub = 0;
    rows.forEach(r=>{
      sub += r.t;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.d||'—'}</td><td class="right">${r.q.toFixed(2)}</td><td class="right">${cur}${r.u.toFixed(2)}</td><td class="right">${cur}${r.t.toFixed(2)}</td>`;
      pItems.appendChild(tr);
    });
    const taxAmt = sub*(tax/100), discAmt = sub*(disc/100); const total = sub + taxAmt - discAmt;
    document.getElementById('pTotals').innerHTML = `
      <tr><td colspan="3" class="right">Subtotal</td><td class="right">${cur}${sub.toFixed(2)}</td></tr>
      <tr><td colspan="3" class="right">Tax (${tax}%)</td><td class="right">${cur}${taxAmt.toFixed(2)}</td></tr>
      <tr><td colspan="3" class="right">Discount (${disc}%)</td><td class="right">-${cur}${discAmt.toFixed(2)}</td></tr>
      <tr><td colspan="3" class="right" style="font-size:16px">Total</td><td class="right" style="font-size:16px">${cur}${total.toFixed(2)}</td></tr>`;

    // AI terms + email
    const aiLoading = document.getElementById('aiLoading');
    aiLoading.innerHTML = '<span class="spinner"></span> Writing terms & email…';
    try{
      const cleanItems = rows.map(r=>`${r.q} × ${r.d} @ ${cur}${r.u}`).join('; ');
      const terms = await callAI([
        {role:'system', content:'Write concise, friendly but professional payment terms (3–5 bullet points max).'},
        {role:'user', content:`Business: ${from}. Client: ${to}. Total: ${cur}${total.toFixed(2)}. Deliverables: ${cleanItems}.`}
      ], 0.5);
      document.getElementById('terms').innerHTML = terms.replace(/\n/g,'<br>');

      const emailTxt = await callAI([
        {role:'system', content:'Write a short, professional invoice email. 120–180 words. Neutral, polite. Include amount, due date, and how to pay. No placeholders.'},
        {role:'user', content:`From ${from} to ${to}. Invoice ${invNo}. Total ${cur}${total.toFixed(2)}. Due ${due}.`}
      ], 0.5);
      window._emailForCopy = emailTxt;
    }catch(e){ alert('AI text failed. Invoice math is still ready.'); }
    aiLoading.textContent='';
  };

  document.getElementById('copyEmail').onclick = ()=>{
    const txt = window._emailForCopy || 'Hello,\nPlease find the invoice attached.\nThank you.';
    navigator.clipboard.writeText(txt).then(()=>alert('Email text copied'));
  };
  document.getElementById('printBtn').onclick = ()=> window.print();
</script>
</body>
</html>
